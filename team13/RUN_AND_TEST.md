# راهنمای اجرا و تست دستی — تیم ۱۳ (امکانات و حمل‌ونقل)

همهٔ دستورات از **ریشهٔ پروژه** (پوشهٔ حاوی `manage.py`) اجرا شوند.

---

## مرحله ۱ — نصب وابستگی‌ها

```powershell
cd c:\Users\iliya\OneDrive\Desktop\soft7\soft-axiom
py -3.11 -m pip install -r requirements.txt
py -3.11 -m pip install -r team13\requirements.txt
```

(دومی برای ماژول `requests` است؛ برای Map.ir و اسکریپت‌های بارگذاری داده لازم است.)

---

## مرحله ۲ — تنظیم محیط (فقط تیم ۱۳)

در فایل `.env` در ریشهٔ پروژه مقدار زیر را قرار دهید تا فقط اپ team13 لود شود (سریع‌تر):

```
TEAM_APPS=team13
```

اگر این خط را نگذارید، همهٔ تیم‌ها لود می‌شوند و سرور کندتر بالا می‌آید؛ در هر صورت team13 کار می‌کند.

---

## مرحله ۳ — مایگریشن دیتابیس

```powershell
py -3.11 manage.py makemigrations team13
py -3.11 manage.py migrate
```

دیتابیس پیش‌فرض (و در صورت تنظیم، دیتابیس team13) ساخته/به‌روز می‌شود.

---

## مرحله ۴ — بارگذاری دادهٔ نمونه (اختیاری ولی توصیه می‌شود)

برای داشتن مکان و رویداد برای تست:

```powershell
py -3.11 manage.py loaddata_team13_csv
```

برای خالی کردن و بارگذاری مجدد:

```powershell
py -3.11 manage.py loaddata_team13_csv --clear
```

---

## مرحله ۵ — اجرای سرور

```powershell
py -3.11 manage.py runserver
```

سرور روی `http://127.0.0.1:8000` بالا می‌آید.

---

## مرحله ۶ — تست دستی در مرورگر

در مرورگر این آدرس‌ها را باز کنید:

| صفحه | آدرس |
|------|------|
| صفحهٔ اصلی team13 | http://127.0.0.1:8000/team13/ |
| لیست مکان‌ها | http://127.0.0.1:8000/team13/places/ |
| لیست رویدادها | http://127.0.0.1:8000/team13/events/ |
| مسیریابی | http://127.0.0.1:8000/team13/routes/ |
| مراکز امدادی | http://127.0.0.1:8000/team13/emergency/ |
| ping (نیاز به لاگین) | http://127.0.0.1:8000/team13/ping/ |

بعد از بارگذاری داده، از لیست مکان‌ها یک مکان انتخاب کنید و روی آن کلیک کنید تا جزئیات و امتیاز را ببینید. در مسیریابی دو مکان را انتخاب و «محاسبه» کنید.

---

## مرحله ۷ — تست خروجی JSON (API)

با اضافه کردن `?format=json` یا هدر `Accept: application/json` خروجی JSON می‌گیرید:

```powershell
# لیست مکان‌ها
curl "http://127.0.0.1:8000/team13/places/?format=json"

# مراکز امدادی با موقعیت تهران
curl "http://127.0.0.1:8000/team13/emergency/?lat=35.6892&lon=51.3890&format=json"
```

یا در مرورگر:  
`http://127.0.0.1:8000/team13/places/?format=json`

---

## مرحله ۸ — تست با کلید Map.ir (اختیاری)

اگر کلید API مپ را دارید، در `.env` قرار دهید:

```
MAPIR_API_KEY=کلید_شما
```

سپس:

- **مسیریابی:** در صفحهٔ مسیر، حالت «خودرو» را انتخاب کنید؛ فاصله و زمان از API مپ گرفته می‌شود و در صفحه با عبارت «با نقشهٔ مپ» نمایش داده می‌شود.
- **مراکز امدادی:** در همان صفحه، علاوه بر بیمارستان‌های دیتابیس، نتایج Map.ir با برچسب «نقشه مپ» هم نمایش داده می‌شوند.

---

## عیب‌یابی سریع

- **خطای ماژول یا import:** مطمئن شوید از ریشهٔ پروژه و با همان پایتونی که وابستگی‌ها را نصب کرده‌اید اجرا می‌کنید (`py -3.11`).
- **صفحه ۴۰۴ برای /team13/:** مقدار `TEAM_APPS` در `.env` باید شامل `team13` باشد.
- **جدول وجود ندارد:** `py -3.11 manage.py migrate` را دوباره اجرا کنید.
- **لیست مکان‌ها خالی است:** دستور `loaddata_team13_csv` را اجرا کنید (مرحله ۴).
- **خطای «database is locked» در loaddata:** هر برنامه‌ای که ممکن است دیتابیس را باز کرده باشد (مثل runserver، IDE، یا ترمینال دیگر) را ببندید، سپس دوباره `loaddata_team13_csv` را اجرا کنید.
