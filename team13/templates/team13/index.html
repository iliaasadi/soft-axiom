{% load static %}
<!doctype html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ø³Ø§Ù…Ø§Ù†Ù‡ Ø¬Ø§Ù…Ø¹ Ø¢Ú©Ø³ÛŒÙˆÙ… â€” Ø§Ù…Ú©Ø§Ù†Ø§Øª Ùˆ Ø­Ù…Ù„â€ŒÙˆÙ†Ù‚Ù„</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <!-- Leaflet CSS (v1.9.4) -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <link rel="stylesheet" href="{% static 'team13/css/style.css' %}" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              team13: { dark: "#1b4332", primary: "#40916c", bg: "#f8f9fa" },
            },
            fontFamily: { sans: ["Vazirmatn", "Tahoma", "sans-serif"] },
          },
        },
      };
    </script>
  </head>
  <body
    class="team13-map font-sans antialiased"
    style="font-family: &quot;Vazirmatn&quot;, Tahoma, sans-serif"
    data-user-logged-in="{% if team13_user %}true{% else %}false{% endif %}"
  >
    <div id="team13-app" class="team13-app">
      <div id="team13-main-wrap" class="team13-main-wrap">
        <!-- Hamburger: fixed top-right on mobile (no top bar) -->
        <button type="button" id="menu-toggle" class="team13-btn-hamburger" aria-label="Ù…Ù†Ùˆ" aria-expanded="false">
          <span></span><span></span><span></span>
        </button>
        <!-- Sidebar: 350px desktop; drawer on mobile, toggled by hamburger -->
        <aside id="team13-sidebar" class="team13-sidebar" aria-label="Ù…Ù†ÙˆÛŒ Ú©Ù†Ø§Ø±ÛŒ">
          <div class="team13-sidebar-greeting">
            {% if team13_user %}
              <span class="team13-sidebar-greeting-name auth-user-name">Ø³Ù„Ø§Ù…ØŒ {{ team13_user.first_name|default:team13_user.email }}</span>
            {% else %}
              <span class="team13-sidebar-greeting-auth">
                <a href="{% url 'auth' %}?next={{ request.path }}" class="auth-btn-small">ÙˆØ±ÙˆØ¯</a>
                <a href="{% url 'signup' %}" class="auth-btn-small btn-gold">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</a>
              </span>
            {% endif %}
            <button type="button" id="team13-btn-favorites" class="team13-link-favorites" title="Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ø¹Ù„Ø§Ù‚Ù‡" aria-label="Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ø¹Ù„Ø§Ù‚Ù‡">â­ Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ø¹Ù„Ø§Ù‚Ù‡</button>
          </div>
          <div class="team13-sidebar-header">
            <div class="team13-home-wrap">
              <button type="button" id="team13-btn-home" class="team13-btn-home team13-btn-primary" title="Back to Home" aria-label="Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø®Ø§Ù†Ù‡">
                <span class="team13-btn-home-icon" aria-hidden="true"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></span>
                <span class="team13-btn-home-label">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø®Ø§Ù†Ù‡</span>
              </button>
            </div>
          </div>
          <div class="team13-tabs flex border-b" role="tablist">
            <button
              type="button"
              class="sidebar-tab team13-tab-btn active flex-1"
              data-tab="events"
              aria-selected="true"
            >
              Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§
            </button>
            <button
              type="button"
              class="sidebar-tab team13-tab-btn flex-1"
              data-tab="routes"
              aria-selected="false"
            >
              Ù…Ø³ÛŒØ±
            </button>
            <button
              type="button"
              class="sidebar-tab team13-tab-btn flex-1"
              data-tab="discovery"
              aria-selected="false"
            >
              Ø§Ø·Ø±Ø§Ù Ù…Ù†
            </button>
          </div>
          <div class="team13-panels-wrap flex-1 overflow-hidden flex flex-col min-h-0">
            <section
              id="panel-events"
              class="team13-panel team13-panel-events bg-[#f8f9fa] active"
              role="tabpanel"
            >
              <p class="text-sm text-gray-600 mb-3">Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§.</p>
              <div class="team13-events-city-wrap mb-3">
                <label class="team13-field-label team13-block mb-1" for="team13-events-city-input">Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù‡Ø±</label>
                <input type="text" id="team13-events-city-input" class="team13-events-city-input" placeholder="Ù†Ø§Ù… Ø´Ù‡Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" autocomplete="off" />
              </div>
              <button type="button" id="team13-events-near-me" class="team13-btn-events-near-me">Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø§Ø·Ø±Ø§Ù Ù…Ù†</button>
              <div id="events-list" class="space-y-2 mt-3"></div>
            </section>
            <section
              id="panel-routes"
              class="team13-panel bg-[#f8f9fa]"
              role="tabpanel"
            >
              <p class="text-sm text-gray-600 mb-3">Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ùˆ Ù…Ø±Ø§Ú©Ø² Ø§Ù…Ø¯Ø§Ø¯ÛŒ.</p>
              <div id="team13-start-dest-wrap" class="team13-start-dest-wrap team13-route-card ui-card">
                <div class="team13-field-row">
                  <label class="team13-field-label" for="team13-input-start">Ù…Ø¨Ø¯Ø§</label>
                  <div class="team13-input-btn-row">
                    <div class="team13-input-with-clear">
                      <input type="text" id="team13-input-start" class="team13-input-route" placeholder="Ø¢Ø¯Ø±Ø³ ÛŒØ§ Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø² Ù†Ù‚Ø´Ù‡" autocomplete="off" />
                      <button type="button" id="team13-clear-start" class="team13-btn-input-clear" aria-label="Ø­Ø°Ù Ù…Ø¨Ø¯Ø§" title="Ø­Ø°Ù">Ã—</button>
                    </div>
                    <div class="team13-sub-options">
                      <button type="button" id="team13-btn-pick-start" class="team13-btn-pick-map" title="Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø² Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡">Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø² Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡</button>
                      <button type="button" id="team13-btn-my-location" class="team13-btn-my-location" title="Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù†">Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù†</button>
                    </div>
                  </div>
                  <div id="team13-start-results" class="team13-autocomplete-results" hidden></div>
                </div>
                <div class="team13-swap-wrap">
                  <button type="button" id="team13-btn-swap-route" class="team13-btn-swap-route" aria-label="Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ Ù…Ø¨Ø¯Ø§ Ùˆ Ù…Ù‚ØµØ¯" title="Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ Ù…Ø¨Ø¯Ø§ Ùˆ Ù…Ù‚ØµØ¯"><span class="team13-swap-icon" aria-hidden="true">â‡…</span></button>
                </div>
                <div class="team13-field-row">
                  <label class="team13-field-label" for="team13-input-dest">Ù…Ù‚ØµØ¯</label>
                  <div class="team13-input-btn-row">
                    <div class="team13-input-with-clear">
                      <input type="text" id="team13-input-dest" class="team13-input-route" placeholder="Ø¢Ø¯Ø±Ø³ ÛŒØ§ Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø² Ù†Ù‚Ø´Ù‡" autocomplete="off" />
                      <button type="button" id="team13-clear-dest" class="team13-btn-input-clear" aria-label="Ø­Ø°Ù Ù…Ù‚ØµØ¯" title="Ø­Ø°Ù">Ã—</button>
                    </div>
                    <div class="team13-sub-options">
                      <button type="button" id="team13-btn-pick-dest" class="team13-btn-pick-map" title="Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø² Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡">Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø² Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡</button>
                    </div>
                  </div>
                  <div id="team13-dest-results" class="team13-autocomplete-results" hidden></div>
                </div>
                <div id="team13-route-mode-wrap" class="team13-route-mode-wrap">
                  <span class="team13-route-mode-label">Ù†ÙˆØ¹ Ù…Ø³ÛŒØ±:</span>
                  <button type="button" class="transport-btn team13-route-mode-btn active active-transport" data-mode="driving"><span class="team13-transport-icon" aria-hidden="true">ğŸš—</span><span class="team13-transport-label">Ø®ÙˆØ¯Ø±Ùˆ</span></button>
                  <button type="button" class="transport-btn team13-route-mode-btn" data-mode="bicycle"><span class="team13-transport-icon" aria-hidden="true">ğŸš²</span><span class="team13-transport-label">Ø¯ÙˆÚ†Ø±Ø®Ù‡</span></button>
                  <button type="button" class="transport-btn team13-route-mode-btn" data-mode="walking"><span class="team13-transport-icon" aria-hidden="true">ğŸš¶</span><span class="team13-transport-label">Ù¾ÛŒØ§Ø¯Ù‡</span></button>
                </div>
              </div>
              <div id="route-info-box" class="team13-route-info-box mb-3">
                <p class="team13-route-info-box-title">Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø³ÛŒØ±</p>
                <div id="route-info-box-content" class="team13-route-info-box-content text-sm text-gray-600">
                  Ù…Ø³ÛŒØ±ÛŒ Ø±Ø§ Ø§Ø² Ù†Ù‚Ø´Ù‡ ÛŒØ§ Ø¬Ø³ØªØ¬Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.
                </div>
                <div id="team13-clear-route-wrap" class="team13-clear-route-wrap" style="display: none;" dir="rtl">
                  <button type="button" id="team13-btn-clear-path" class="team13-btn-clear-path" aria-label="Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù…Ø³ÛŒØ±"><span class="team13-clear-route-icon" aria-hidden="true">ğŸ—‘</span><span class="team13-clear-route-text">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù…Ø³ÛŒØ±</span></button>
                </div>
              </div>
            </section>
            <section
              id="panel-discovery"
              class="team13-panel team13-discovery-panel bg-[#f8f9fa]"
              role="tabpanel"
            >
              <p class="text-sm text-gray-600 mb-3">Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù…Ø­Ø¯ÙˆØ¯Ù‡ (Ù…ØªØ±Ø§Ú˜ Ùˆ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ).</p>
              <div class="team13-discovery-point mb-3">
                <span class="team13-field-label team13-block mb-1">Ù†Ù‚Ø·Ù‡ Ù…Ø±Ú©Ø²</span>
                <div class="team13-discovery-btns">
                  <button type="button" id="team13-discovery-my-location" class="team13-btn-discovery">Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù†</button>
                  <button type="button" id="team13-discovery-pick-map" class="team13-btn-discovery">Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø² Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡</button>
                </div>
              </div>
              <div class="team13-discovery-radius mb-3">
                <label class="team13-field-label team13-block mb-1" for="team13-discovery-radius">Ø´Ø¹Ø§Ø¹: <span id="team13-discovery-radius-value">2</span> Ú©ÛŒÙ„ÙˆÙ…ØªØ±</label>
                <input type="range" id="team13-discovery-radius" class="team13-discovery-slider" min="0.5" max="10" step="0.5" value="2" />
              </div>
              <div class="team13-discovery-categories mb-3">
                <span class="team13-field-label team13-block mb-1">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</span>
                <div class="team13-discovery-chips team13-discovery-category-grid">
                  <label class="team13-discovery-chip"><input type="checkbox" name="discovery-cat" value="food" /><span class="team13-discovery-chip-icon" aria-hidden="true">ğŸ´</span><span class="team13-discovery-chip-label">Ø±Ø³ØªÙˆØ±Ø§Ù†</span></label>
                  <label class="team13-discovery-chip"><input type="checkbox" name="discovery-cat" value="hotel" /><span class="team13-discovery-chip-icon" aria-hidden="true">ğŸ¨</span><span class="team13-discovery-chip-label">Ù‡ØªÙ„</span></label>
                  <label class="team13-discovery-chip"><input type="checkbox" name="discovery-cat" value="hospital" /><span class="team13-discovery-chip-icon" aria-hidden="true">ğŸ¥</span><span class="team13-discovery-chip-label">Ø¨ÛŒÙ…Ø§Ø±Ø³ØªØ§Ù†</span></label>
                  <label class="team13-discovery-chip"><input type="checkbox" name="discovery-cat" value="museum" /><span class="team13-discovery-chip-icon" aria-hidden="true">ğŸ›ï¸</span><span class="team13-discovery-chip-label">Ù…ÙˆØ²Ù‡</span></label>
                  <label class="team13-discovery-chip"><input type="checkbox" name="discovery-cat" value="entertainment" /><span class="team13-discovery-chip-icon" aria-hidden="true">ğŸ¡</span><span class="team13-discovery-chip-label">ØªÙØ±ÛŒØ­ÛŒ</span></label>
                </div>
              </div>
              <div class="team13-discovery-actions">
                <button type="button" id="team13-discovery-search" class="team13-btn-discovery-search">Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø§ÛŒÙ† Ù…Ø­Ø¯ÙˆØ¯Ù‡</button>
                <button type="button" id="team13-discovery-clear-area" class="team13-btn-discovery-clear-area">Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù…Ø­Ø¯ÙˆØ¯Ù‡</button>
                <button type="button" id="team13-discovery-deselect" class="team13-btn-discovery-deselect" title="Ø­Ø°Ù Ø¯Ø§ÛŒØ±Ù‡ Ùˆ Ù†Ø´Ø§Ù†Ú¯Ø±Ù‡Ø§">Ø§Ù†ØµØ±Ø§Ù</button>
              </div>
            </section>
          </div>
          <div class="team13-sidebar-auth-bottom">
            <button type="button" id="team13-btn-emergency" class="team13-btn-emergency" aria-label="Ø§Ù…Ø¯Ø§Ø¯ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ">Ø§Ù…Ø¯Ø§Ø¯ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ</button>
            {% if team13_user %}
              <a href="{% url 'logout' %}" class="team13-btn-logout">Ø®Ø±ÙˆØ¬</a>
            {% endif %}
          </div>
        </aside>
        <!-- Overlay when sidebar open on mobile (tap to close) -->
        <div id="team13-sidebar-overlay" class="team13-sidebar-overlay" aria-hidden="true"></div>

        <!-- Favorites: login gate (inside add modal when not logged in) - no separate modal -->

        <!-- Favorites: list modal (primary view when Star clicked and logged in) -->
        <div id="team13-modal-favorites-list" class="team13-modal-overlay" role="dialog" aria-labelledby="team13-modal-favorites-list-title" aria-modal="true" hidden>
          <div class="team13-modal team13-modal-favorites-list">
            <h2 id="team13-modal-favorites-list-title" class="team13-modal-title">Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</h2>
            <div class="team13-favorites-list-actions">
              <button type="button" id="team13-btn-add-new-favorite" class="team13-btn-add-favorite team13-btn-yellow">Ø§ÙØ²ÙˆØ¯Ù† Ù…Ú©Ø§Ù† Ø¬Ø¯ÛŒØ¯</button>
              <button type="button" class="team13-btn-modal-close" data-close="team13-modal-favorites-list">Ø¨Ø³ØªÙ†</button>
            </div>
            <div id="team13-favorites-list" class="team13-favorites-list"></div>
          </div>
        </div>

        <!-- Favorites: Route to Here â€” choose start point -->
        <div id="team13-modal-route-start" class="team13-modal-overlay" role="dialog" aria-labelledby="team13-modal-route-start-title" aria-modal="true" hidden>
          <div class="team13-modal team13-modal-route-start">
            <h2 id="team13-modal-route-start-title" class="team13-modal-title">Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ â€” Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø¨Ø¯Ø§</h2>
            <p class="team13-modal-text">Ù…Ø¨Ø¯Ø§ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</p>
            <div class="team13-favorite-picker-options">
              <button type="button" id="team13-route-start-current" class="team13-favorite-picker-btn team13-btn-yellow">Ù…ÙˆÙ‚Ø¹ÛŒØª ÙØ¹Ù„ÛŒ</button>
              <button type="button" id="team13-route-start-map" class="team13-favorite-picker-btn team13-btn-yellow">Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø² Ù†Ù‚Ø´Ù‡</button>
              <div class="team13-favorite-search-wrap">
                <label class="team13-field-label" for="team13-route-start-search">Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¢Ø¯Ø±Ø³ Ù…Ø¨Ø¯Ø§</label>
                <input type="text" id="team13-route-start-search" class="team13-input-route" placeholder="Ø¢Ø¯Ø±Ø³ Ù…Ø¨Ø¯Ø§..." autocomplete="off" />
                <div id="team13-route-start-results" class="team13-favorite-search-results" hidden></div>
              </div>
            </div>
            <div class="team13-modal-actions">
              <button type="button" class="team13-btn-modal-close" data-close="team13-modal-route-start">Ø§Ù†ØµØ±Ø§Ù</button>
            </div>
          </div>
        </div>

        <!-- Favorites: Details (Info) modal -->
        <div id="team13-modal-favorite-details" class="team13-modal-overlay" role="dialog" aria-labelledby="team13-modal-favorite-details-title" aria-modal="true" hidden>
          <div class="team13-modal team13-modal-favorite-details">
            <h2 id="team13-modal-favorite-details-title" class="team13-modal-title">Ø¬Ø²Ø¦ÛŒØ§Øª</h2>
            <div id="team13-favorite-details-content" class="team13-favorite-details-content"></div>
            <div class="team13-modal-actions">
              <button type="button" class="team13-btn-modal-close" data-close="team13-modal-favorite-details">Ø¨Ø³ØªÙ†</button>
            </div>
          </div>
        </div>

        <!-- Favorites: Add Favorite modal (login gate + 3-way location picker + customization) -->
        <div id="team13-modal-add-favorite" class="team13-modal-overlay" role="dialog" aria-labelledby="team13-modal-add-favorite-title" aria-modal="true" hidden>
          <div class="team13-modal team13-modal-add-favorite">
            <h2 id="team13-modal-add-favorite-title" class="team13-modal-title">Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒ</h2>

            <div id="team13-favorite-login-gate" class="team13-favorite-step">
              <p class="team13-modal-text">Please log in to save favorites.</p>
              <div class="team13-modal-actions">
                <a href="{% url 'auth' %}?next={{ request.path }}" class="team13-btn-login-modal team13-btn-yellow">ÙˆØ±ÙˆØ¯</a>
                <button type="button" class="team13-btn-modal-close" data-close="team13-modal-add-favorite">Ø¨Ø³ØªÙ†</button>
              </div>
            </div>

            <div id="team13-favorite-step-picker" class="team13-favorite-step" style="display: none;">
              <p class="team13-modal-text team13-favorite-step-label">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ú©Ø§Ù† Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯:</p>
              <div class="team13-favorite-picker-options">
                <button type="button" id="team13-favorite-btn-current" class="team13-favorite-picker-btn team13-btn-yellow">Ù…ÙˆÙ‚Ø¹ÛŒØª ÙØ¹Ù„ÛŒ</button>
                <button type="button" id="team13-favorite-btn-map" class="team13-favorite-picker-btn team13-btn-yellow">Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø² Ù†Ù‚Ø´Ù‡</button>
                <div class="team13-favorite-search-wrap">
                  <label class="team13-field-label" for="team13-favorite-search-input">Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¢Ø¯Ø±Ø³</label>
                  <div class="team13-favorite-search-input-wrap">
                    <span class="team13-favorite-search-icon" aria-hidden="true">ğŸ”</span>
                    <input type="text" id="team13-favorite-search-input" class="team13-input-route team13-favorite-search-input" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ù…Ú©Ø§Ù† ÛŒØ§ Ø¢Ø¯Ø±Ø³..." autocomplete="off" dir="rtl" />
                  </div>
                  <div id="team13-favorite-search-results" class="team13-favorite-search-results" hidden></div>
                </div>
              </div>
            </div>

            <form id="team13-form-add-favorite" class="team13-form-add-favorite team13-favorite-step" style="display: none;">
              <input type="hidden" id="team13-favorite-lat" name="lat" />
              <input type="hidden" id="team13-favorite-lng" name="lng" />
              <input type="hidden" id="team13-favorite-address" name="address" />
              <div class="team13-form-row">
                <label class="team13-field-label" for="team13-favorite-name">Ù†Ø§Ù… Ù…Ú©Ø§Ù† (Ù…Ø«Ù„Ø§Ù‹ Ø®Ø§Ù†Ù‡ØŒ Ù…Ø­Ù„ Ú©Ø§Ø±)</label>
                <input type="text" id="team13-favorite-name" class="team13-input-route" placeholder="Ù…Ø«Ø§Ù„: Ø®Ø§Ù†Ù‡" required />
              </div>
              <div class="team13-form-row">
                <label class="team13-field-label">Ù†ÙˆØ¹ Ù†Ù…Ø§ÛŒØ´</label>
                <select id="team13-favorite-type" class="team13-input-route">
                  <option value="other">Ø³Ø§ÛŒØ±</option>
                  <option value="restaurant">Ø±Ø³ØªÙˆØ±Ø§Ù†</option>
                  <option value="hospital">Ø¨ÛŒÙ…Ø§Ø±Ø³ØªØ§Ù†</option>
                  <option value="hotel">Ù‡ØªÙ„</option>
                  <option value="museum">Ù…ÙˆØ²Ù‡</option>
                  <option value="entertainment">ØªÙØ±ÛŒØ­ÛŒ</option>
                  <option value="gym">ÙˆØ±Ø²Ø´Ú¯Ø§Ù‡</option>
                </select>
              </div>
              <div class="team13-form-row">
                <span class="team13-field-label">Ø§Ù†ØªØ®Ø§Ø¨ Ø¢ÛŒÚ©ÙˆÙ†</span>
                <div class="team13-favorite-icon-pick" role="group" aria-label="Ø§Ù†ØªØ®Ø§Ø¨ Ø¢ÛŒÚ©ÙˆÙ†">
                  <label class="team13-icon-option"><input type="radio" name="favorite-icon" value="ğŸ " checked /> ğŸ </label>
                  <label class="team13-icon-option"><input type="radio" name="favorite-icon" value="ğŸ’¼" /> ğŸ’¼</label>
                  <label class="team13-icon-option"><input type="radio" name="favorite-icon" value="â¤ï¸" /> â¤ï¸</label>
                  <label class="team13-icon-option"><input type="radio" name="favorite-icon" value="â­" /> â­</label>
                  <label class="team13-icon-option"><input type="radio" name="favorite-icon" value="ğŸ‹ï¸" /> ğŸ‹ï¸</label>
                </div>
              </div>
              <div class="team13-modal-actions">
                <button type="submit" class="team13-btn-save-favorite team13-btn-yellow">Ø°Ø®ÛŒØ±Ù‡</button>
                <button type="button" id="team13-favorite-back-picker" class="team13-btn-modal-close">ØªØºÛŒÛŒØ± Ù…Ú©Ø§Ù†</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Main: map (flex-grow) -->
        <main class="team13-map-main">
          <div class="team13-map-search-wrap">
            <div class="team13-search-input-wrap">
              <input type="text" id="team13-search-input" class="team13-search-input" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ù…Ú©Ø§Ù† ÛŒØ§ Ø¢Ø¯Ø±Ø³..." autocomplete="off" />
              <button type="button" id="team13-clear-search" class="team13-btn-search-clear team13-search-clear-btn search-cancel-btn" aria-label="Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†" data-tooltip="Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†">Ã—</button>
            </div>
            <div id="team13-search-results" class="team13-search-results" hidden></div>
          </div>
          <div id="team13-route-info" class="team13-route-info" hidden>
            <p class="team13-route-info-title">Ù…Ø³ÛŒØ± Ùˆ Ø²Ù…Ø§Ù† Ø±Ø³ÛŒØ¯Ù†</p>
            <p id="team13-route-distance" class="team13-route-info-text"></p>
            <p id="team13-route-eta" class="team13-route-info-text"></p>
          </div>
          <div id="team13-route-loading" class="team13-route-loading" hidden>
            <span class="team13-spinner"></span>
            <span>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø³ÛŒØ±...</span>
          </div>
          <div
            id="map-container"
            class="team13-map-wrap absolute inset-0"
          ></div>
          <button type="button" id="team13-btn-center-me" class="team13-btn-center-me" aria-label="Ù…Ú©Ø§Ù† Ù…Ù†" title="Ù…Ø±Ú©Ø² Ø±ÙˆÛŒ Ù…Ù†">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
          </button>
          <div id="team13-toast" class="team13-toast" aria-live="polite"></div>
        </main>
      </div>
    </div>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <!-- Required for Map.ir route geometry decoding (polyline.decode) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mapbox-polyline/1.1.1/polyline.js"></script>
    <script src="{% static 'team13/js/api_client.js' %}"></script>
    <script src="{% static 'team13/js/map_init.js' %}"></script>
    <script src="{% static 'team13/js/map_data.js' %}"></script>
    <script>
      (function () {
        var tabs = document.querySelectorAll(".team13-tab-btn");
        var panels = document.querySelectorAll(".team13-panel");
        tabs.forEach(function (btn) {
          btn.addEventListener("click", function () {
            var tabId = this.getAttribute("data-tab");
            tabs.forEach(function (t) {
              t.classList.remove("active");
              t.setAttribute("aria-selected", "false");
            });
            panels.forEach(function (p) {
              p.classList.remove("active");
            });
            this.classList.add("active");
            this.setAttribute("aria-selected", "true");
            var panel = document.getElementById("panel-" + tabId);
            if (panel) panel.classList.add("active");
            if (tabId === "events" && window.Team13MapData && typeof window.Team13MapData.onEventsTabActivated === "function") {
              window.Team13MapData.onEventsTabActivated();
            }
          });
        });
        var sidebar = document.getElementById("team13-sidebar");
        var overlay = document.getElementById("team13-sidebar-overlay");
        var hamburger = document.getElementById("menu-toggle") || document.getElementById("hamburger-menu") || document.querySelector(".team13-btn-hamburger");
        function closeSidebar() {
          document.body.classList.remove("team13-sidebar-open");
          if (sidebar) {
            sidebar.classList.remove("team13-sidebar-open");
            sidebar.classList.remove("active");
            sidebar.classList.remove("active-sidebar");
          }
          if (overlay) overlay.classList.remove("team13-sidebar-overlay-visible");
          if (hamburger) {
            hamburger.setAttribute("aria-expanded", "false");
            hamburger.classList.remove("is-active", "open", "team13-hamburger-hidden");
          }
        }
        function openSidebar() {
          document.body.classList.add("team13-sidebar-open");
          if (sidebar) {
            sidebar.classList.add("team13-sidebar-open");
            sidebar.classList.add("active");
            sidebar.classList.add("active-sidebar");
          }
          if (overlay) overlay.classList.add("team13-sidebar-overlay-visible");
          if (hamburger) {
            hamburger.setAttribute("aria-expanded", "true");
            hamburger.classList.add("is-active", "open");
          }
        }
        function toggleSidebar() {
          if (sidebar && (sidebar.classList.contains("team13-sidebar-open") || sidebar.classList.contains("active") || sidebar.classList.contains("active-sidebar"))) closeSidebar();
          else openSidebar();
        }
        if (hamburger) hamburger.addEventListener("click", toggleSidebar);
        if (overlay) overlay.addEventListener("click", closeSidebar);
        window.Team13CloseSidebar = closeSidebar;
        window.Team13OpenSidebar = openSidebar;
      })();

      (function () {
        function openSidebarAndRouteTab() {
          if (typeof window.Team13OpenSidebar === "function") window.Team13OpenSidebar();
          var routeTab = document.querySelector("[data-tab=\"routes\"]");
          if (routeTab) {
            routeTab.click();
            var panels = document.querySelectorAll(".team13-panel");
            document.querySelectorAll(".team13-tab-btn").forEach(function (t) { t.classList.remove("active"); t.setAttribute("aria-selected", "false"); });
            panels.forEach(function (p) { p.classList.remove("active"); });
            routeTab.classList.add("active");
            routeTab.setAttribute("aria-selected", "true");
            var panelRoutes = document.getElementById("panel-routes");
            if (panelRoutes) panelRoutes.classList.add("active");
          }
        }
        function applyRouteFromUrl() {
          var params = new URLSearchParams(window.location.search);
          var action = params.get("action");
          if (!action) return;

          if (action === "route") {
            var destName = params.get("dest_name");
            var destLat = params.get("dest_lat");
            var destLng = params.get("dest_lng");
            if (!destLat || !destLng) return;
            var decodedName = destName ? decodeURIComponent(destName) : "";
            openSidebarAndRouteTab();
            var inputStart = document.getElementById("team13-input-start");
            if (inputStart) inputStart.value = "";
            if (window.Team13MapData && typeof window.Team13MapData.setDestFromCoords === "function") {
              var lat = parseFloat(destLat);
              var lng = parseFloat(destLng);
              if (!isNaN(lat) && !isNaN(lng)) window.Team13MapData.setDestFromCoords(lat, lng, decodedName);
            }
            try { window.history.replaceState({}, "", window.location.pathname); } catch (e) {}
            return;
          }

          if (action === "draw_route") {
            var startLat = params.get("start_lat");
            var startLng = params.get("start_lng");
            var endLat = params.get("end_lat");
            var endLng = params.get("end_lng");
            var mode = params.get("mode") || "driving";
            var startName = params.get("start_name") ? decodeURIComponent(params.get("start_name")) : "";
            var endName = params.get("end_name") ? decodeURIComponent(params.get("end_name")) : "";
            if (!startLat || !startLng || !endLat || !endLng) return;
            var slat = parseFloat(startLat);
            var slng = parseFloat(startLng);
            var elat = parseFloat(endLat);
            var elng = parseFloat(endLng);
            if (isNaN(slat) || isNaN(slng) || isNaN(elat) || isNaN(elng)) return;
            openSidebarAndRouteTab();
            var md = window.Team13MapData;
            if (md && typeof md.setRouteMode === "function") md.setRouteMode(mode);
            if (md && typeof md.setStartFromCoords === "function") md.setStartFromCoords(slat, slng, startName);
            if (md && typeof md.setDestFromCoords === "function") md.setDestFromCoords(elat, elng, endName);
            try { window.history.replaceState({}, "", window.location.pathname); } catch (e) {}
          }
        }
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", function () { setTimeout(applyRouteFromUrl, 200); });
        } else {
          setTimeout(applyRouteFromUrl, 200);
        }
      })();

      (function () {
        var FAVORITES_KEY = "team13_favorites";
        var btnFavorites = document.getElementById("team13-btn-favorites");
        var modalList = document.getElementById("team13-modal-favorites-list");
        var modalAdd = document.getElementById("team13-modal-add-favorite");
        var stepLogin = document.getElementById("team13-favorite-login-gate");
        var stepPicker = document.getElementById("team13-favorite-step-picker");
        var formAdd = document.getElementById("team13-form-add-favorite");
        var favoritesListEl = document.getElementById("team13-favorites-list");
        var btnAddNew = document.getElementById("team13-btn-add-new-favorite");
        var typeLabels = { other: "Ø³Ø§ÛŒØ±", restaurant: "Ø±Ø³ØªÙˆØ±Ø§Ù†", hospital: "Ø¨ÛŒÙ…Ø§Ø±Ø³ØªØ§Ù†", hotel: "Ù‡ØªÙ„", museum: "Ù…ÙˆØ²Ù‡", entertainment: "ØªÙØ±ÛŒØ­ÛŒ", gym: "ÙˆØ±Ø²Ø´Ú¯Ø§Ù‡" };

        function isLoggedIn() { return document.body.getAttribute("data-user-logged-in") === "true"; }
        function getFavorites() { try { var raw = localStorage.getItem(FAVORITES_KEY); return raw ? JSON.parse(raw) : []; } catch (e) { return []; } }
        function setFavorites(arr) { localStorage.setItem(FAVORITES_KEY, JSON.stringify(arr)); }

        function showModal(el) {
          if (el) { el.hidden = false; el.classList.add("team13-modal-open"); }
          if (el && (el.id === "team13-modal-add-favorite" || el.id === "team13-modal-favorites-list" || el.id === "team13-modal-route-start" || el.id === "team13-modal-favorite-details"))
            document.body.classList.add("team13-favorite-modal-open");
        }
        function hideModal(el) {
          if (el) { el.hidden = true; el.classList.remove("team13-modal-open"); }
          if (el && el.id === "team13-modal-add-favorite" && window.Team13MapData && typeof window.Team13MapData.clearFavoritePickMarker === "function")
            window.Team13MapData.clearFavoritePickMarker();
          if (el && (el.id === "team13-modal-add-favorite" || el.id === "team13-modal-favorites-list" || el.id === "team13-modal-route-start" || el.id === "team13-modal-favorite-details"))
            document.body.classList.remove("team13-favorite-modal-open");
        }

        function showAddFavoriteStep(stepName) {
          if (stepLogin) stepLogin.style.display = stepName === "login" ? "block" : "none";
          if (stepPicker) stepPicker.style.display = stepName === "picker" ? "block" : "none";
          if (formAdd) formAdd.style.display = stepName === "form" ? "block" : "none";
        }

        function setFavoriteCoords(lat, lng, typeValue, suggestedName) {
          var latEl = document.getElementById("team13-favorite-lat");
          var lngEl = document.getElementById("team13-favorite-lng");
          var nameEl = document.getElementById("team13-favorite-name");
          var addressEl = document.getElementById("team13-favorite-address");
          var typeSelect = document.getElementById("team13-favorite-type");
          if (latEl) latEl.value = lat;
          if (lngEl) lngEl.value = lng;
          if (suggestedName && nameEl) nameEl.value = suggestedName;
          if (suggestedName && addressEl) addressEl.value = suggestedName;
          if (typeValue && typeSelect) {
            var opt = typeSelect.querySelector("option[value=\"" + typeValue + "\"]");
            if (opt) typeSelect.value = typeValue;
          }
          showAddFavoriteStep("form");
        }

        if (btnFavorites) {
          btnFavorites.addEventListener("click", function () {
            if (!isLoggedIn()) {
              showModal(modalAdd);
              showAddFavoriteStep("login");
              return;
            }
            renderFavoritesList();
            showModal(modalList);
          });
        }

        var btnCurrent = document.getElementById("team13-favorite-btn-current");
        if (btnCurrent) {
          btnCurrent.addEventListener("click", function () {
            if (!navigator.geolocation) { alert("Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯."); return; }
            navigator.geolocation.getCurrentPosition(
              function (pos) { setFavoriteCoords(pos.coords.latitude, pos.coords.longitude); },
              function () { alert("Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯."); },
              { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
            );
          });
        }

        var btnMap = document.getElementById("team13-favorite-btn-map");
        if (btnMap && window.Team13MapData && typeof window.Team13MapData.startMapPickForFavorite === "function") {
          btnMap.addEventListener("click", function () {
            hideModal(modalAdd);
            if (typeof window.showToast === "function") window.showToast("Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ØªØ§ Ù…Ú©Ø§Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ø´ÙˆØ¯.");
            window.Team13MapData.startMapPickForFavorite(function (lat, lng) {
              if (typeof window.showToast === "function") window.showToast("Ù…Ú©Ø§Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯.");
              setFavoriteCoords(lat, lng);
              showModal(modalAdd);
            });
          });
        }

        var searchInput = document.getElementById("team13-favorite-search-input");
        var searchResults = document.getElementById("team13-favorite-search-results");
        if (searchInput && searchResults && window.Team13MapData && typeof window.Team13MapData.mapirAutocomplete === "function") {
          var searchDebounce;
          searchInput.addEventListener("input", function () {
            clearTimeout(searchDebounce);
            var q = (searchInput.value || "").trim();
            if (q.length < 3) { searchResults.hidden = true; searchResults.innerHTML = ""; return; }
            searchDebounce = setTimeout(function () {
              window.Team13MapData.mapirAutocomplete(q).then(function (items) {
                searchResults.innerHTML = "";
                (items || []).forEach(function (item) {
                  var title = (item.title || item.address || item.name || item.text || "").trim();
                  var ll = window.Team13MapData.getItemLatLng && window.Team13MapData.getItemLatLng(item);
                  if (!ll) return;
                  var lat = ll.lat, lng = ll.lng;
                  var div = document.createElement("div");
                  div.className = "team13-search-result-item";
                  div.textContent = title;
                  div.dataset.lat = lat;
                  div.dataset.lng = lng;
                  div.dataset.title = title;
                  var typeVal = (item.type || item.class || item.category || "").toLowerCase();
                  if (typeVal) { div.dataset.type = typeVal; div.dataset.typeLabel = typeVal; }
                  div.addEventListener("click", function () {
                    var latNum = parseFloat(div.dataset.lat), lngNum = parseFloat(div.dataset.lng);
                    var typeValue = (div.dataset.type || "other").toLowerCase();
                    if (!typeLabels[typeValue]) typeValue = "other";
                    setFavoriteCoords(latNum, lngNum, typeValue, title);
                    searchResults.hidden = true;
                    searchResults.innerHTML = "";
                    searchInput.value = title;
                    if (window.Team13MapData && typeof window.Team13MapData.showFavoritePickMarker === "function")
                      window.Team13MapData.showFavoritePickMarker(latNum, lngNum, title);
                  });
                  searchResults.appendChild(div);
                });
                searchResults.hidden = !items || items.length === 0;
              });
            }, 300);
          });
          searchInput.addEventListener("blur", function () { setTimeout(function () { searchResults.hidden = true; }, 200); });
        }
        if (searchResults) searchResults.className = "team13-favorite-search-results team13-search-results";

        var btnBackPicker = document.getElementById("team13-favorite-back-picker");
        if (btnBackPicker) btnBackPicker.addEventListener("click", function () { showAddFavoriteStep("picker"); });

        if (formAdd) {
          formAdd.addEventListener("submit", function (e) {
            e.preventDefault();
            var nameEl = document.getElementById("team13-favorite-name");
            var typeSelect = document.getElementById("team13-favorite-type");
            var latEl = document.getElementById("team13-favorite-lat");
            var lngEl = document.getElementById("team13-favorite-lng");
            var addressEl = document.getElementById("team13-favorite-address");
            var iconRadio = formAdd.querySelector("input[name=\"favorite-icon\"]:checked");
            var fav = {
              name: (nameEl && nameEl.value) ? nameEl.value.trim() : "",
              type: typeSelect ? typeSelect.value : "other",
              typeLabel: typeSelect ? (typeLabels[typeSelect.value] || typeSelect.value) : "Ø³Ø§ÛŒØ±",
              icon: iconRadio ? iconRadio.value : "â­",
              lat: latEl ? parseFloat(latEl.value) : null,
              lng: lngEl ? parseFloat(lngEl.value) : null,
              address: (addressEl && addressEl.value) ? addressEl.value.trim() : ""
            };
            var arr = getFavorites();
            arr.push(fav);
            setFavorites(arr);
            if (nameEl) nameEl.value = "";
            if (typeSelect) typeSelect.value = "other";
            if (addressEl) addressEl.value = "";
            var firstIcon = formAdd.querySelector("input[name=\"favorite-icon\"]");
            if (firstIcon) firstIcon.checked = true;
            if (latEl) latEl.value = ""; if (lngEl) lngEl.value = "";
            hideModal(modalAdd);
            if (modalList) { renderFavoritesList(); showModal(modalList); }
          });
        }

        var modalRouteStart = document.getElementById("team13-modal-route-start");
        var modalDetails = document.getElementById("team13-modal-favorite-details");
        var detailsContent = document.getElementById("team13-favorite-details-content");

        function isPublicPlace(fav) {
          return fav.type && fav.type !== "other";
        }

        function renderFavoritesList() {
          if (!favoritesListEl) return;
          var list = getFavorites();
          if (list.length === 0) {
            favoritesListEl.innerHTML = "<p class=\"team13-favorites-empty\">Ù‡Ù†ÙˆØ² Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.</p>";
          } else {
            var html = "";
            list.forEach(function (fav, i) {
              var addrOrType = (fav.address && fav.address.trim()) ? fav.address.trim() : (fav.typeLabel || fav.type || "â€”");
              html += "<div class=\"team13-favorite-item\" data-index=\"" + i + "\">" +
                "<span class=\"team13-favorite-item-icon\">" + (fav.icon || "â­") + "</span>" +
                "<div class=\"team13-favorite-item-text\">" +
                "<span class=\"team13-favorite-item-name\">" + (fav.name || "â€”") + "</span>" +
                "<span class=\"team13-favorite-item-addr\">" + addrOrType + "</span>" +
                "</div>" +
                "<div class=\"team13-favorite-item-actions\">" +
                "<button type=\"button\" class=\"team13-fav-btn-route team13-btn-yellow-small\" data-index=\"" + i + "\">Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ</button>" +
                "<button type=\"button\" class=\"team13-fav-btn-info\" data-index=\"" + i + "\">Ø¬Ø²Ø¦ÛŒØ§Øª</button>" +
                "<button type=\"button\" class=\"team13-favorite-item-remove\" data-index=\"" + i + "\" aria-label=\"Ø­Ø°Ù\">Ã—</button>" +
                "</div>" +
                "</div>";
            });
            favoritesListEl.innerHTML = html;
          }
          favoritesListEl.querySelectorAll(".team13-favorite-item-remove").forEach(function (btn) {
            btn.addEventListener("click", function (e) { e.stopPropagation(); var idx = parseInt(btn.getAttribute("data-index"), 10); var arr = getFavorites(); arr.splice(idx, 1); setFavorites(arr); renderFavoritesList(); });
          });
          favoritesListEl.querySelectorAll(".team13-fav-btn-route").forEach(function (btn) {
            btn.addEventListener("click", function (e) { e.stopPropagation(); var idx = parseInt(btn.getAttribute("data-index"), 10); openRouteStartModal(idx); });
          });
          favoritesListEl.querySelectorAll(".team13-fav-btn-info").forEach(function (btn) {
            btn.addEventListener("click", function (e) { e.stopPropagation(); var idx = parseInt(btn.getAttribute("data-index"), 10); openDetailsModal(idx); });
          });
        }

        if (btnAddNew) {
          btnAddNew.addEventListener("click", function () {
            hideModal(modalList);
            showModal(modalAdd);
            showAddFavoriteStep("picker");
            var latEl = document.getElementById("team13-favorite-lat");
            var lngEl = document.getElementById("team13-favorite-lng");
            var addressEl = document.getElementById("team13-favorite-address");
            if (latEl) latEl.value = ""; if (lngEl) lngEl.value = ""; if (addressEl) addressEl.value = "";
          });
        }

        function openRouteStartModal(favIndex) {
          var list = getFavorites();
          var fav = list[favIndex];
          if (!fav || fav.lat == null || fav.lng == null) return;
          window._team13RouteDestFavorite = { lat: fav.lat, lng: fav.lng, name: fav.name || "" };
          hideModal(modalList);
          showModal(modalRouteStart);
        }

        function openDetailsModal(favIndex) {
          var list = getFavorites();
          var fav = list[favIndex];
          if (!fav) return;
          var isPublic = isPublicPlace(fav);
          var html = "";
          if (isPublic) {
            html += "<p class=\"team13-detail-row\"><strong>Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ:</strong> " + (fav.typeLabel || fav.type || "â€”") + "</p>";
            html += "<p class=\"team13-detail-row\"><strong>Ø§Ù…ØªÛŒØ§Ø²:</strong> â€”</p>";
            html += "<p class=\"team13-detail-row\"><strong>Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±ÛŒ:</strong> â€”</p>";
            if (fav.address) html += "<p class=\"team13-detail-row\"><strong>Ø¢Ø¯Ø±Ø³:</strong> " + fav.address + "</p>";
          } else {
            html += "<p class=\"team13-detail-row\"><strong>Ø¨Ø±Ú†Ø³Ø¨:</strong> " + (fav.name || "â€”") + "</p>";
            html += "<p class=\"team13-detail-row\"><strong>Ø¢Ø¯Ø±Ø³:</strong> " + (fav.address || "â€”") + "</p>";
          }
          if (detailsContent) detailsContent.innerHTML = html;
          showModal(modalDetails);
        }

        var routeStartCurrent = document.getElementById("team13-route-start-current");
        var routeStartMap = document.getElementById("team13-route-start-map");
        var routeStartSearch = document.getElementById("team13-route-start-search");
        var routeStartResults = document.getElementById("team13-route-start-results");

        if (routeStartCurrent) {
          routeStartCurrent.addEventListener("click", function () {
            var dest = window._team13RouteDestFavorite;
            if (!dest || !window.Team13MapData) return;
            if (!navigator.geolocation) { if (window.showToast) window.showToast("Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯."); return; }
            navigator.geolocation.getCurrentPosition(
              function (pos) {
                var setStart = window.Team13MapData.setStartFromCoords;
                var setDest = window.Team13MapData.setDestFromCoords;
                var draw = window.Team13MapData.drawRouteFromToIfBoth;
                if (setStart) setStart(pos.coords.latitude, pos.coords.longitude, "");
                if (setDest) setDest(dest.lat, dest.lng, dest.name || "");
                if (draw) draw();
                hideModal(modalRouteStart);
                if (window.Team13CloseSidebar) window.Team13CloseSidebar();
                var tabRoutes = document.querySelector("[data-tab=\"routes\"]");
                if (tabRoutes) tabRoutes.click();
              },
              function () { if (window.showToast) window.showToast("Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯."); },
              { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
            );
          });
        }

        if (routeStartMap && window.Team13MapData && window.Team13MapData.setPickMode && window.Team13MapData.setDestFromCoords) {
          routeStartMap.addEventListener("click", function () {
            var dest = window._team13RouteDestFavorite;
            if (!dest) return;
            window.Team13MapData.setDestFromCoords(dest.lat, dest.lng, dest.name || "");
            window.Team13MapData.setPickMode("start");
            hideModal(modalRouteStart);
            if (window.Team13CloseSidebar) window.Team13CloseSidebar();
            if (window.showToast) window.showToast("Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ØªØ§ Ù…Ø¨Ø¯Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ø´ÙˆØ¯.");
            var tabRoutes = document.querySelector("[data-tab=\"routes\"]");
            if (tabRoutes) tabRoutes.click();
          });
        }

        if (routeStartSearch && routeStartResults && window.Team13MapData && window.Team13MapData.mapirAutocomplete) {
          var routeSearchDebounce;
          routeStartSearch.addEventListener("input", function () {
            clearTimeout(routeSearchDebounce);
            var q = (routeStartSearch.value || "").trim();
            if (q.length < 2) { routeStartResults.hidden = true; routeStartResults.innerHTML = ""; return; }
            routeSearchDebounce = setTimeout(function () {
              window.Team13MapData.mapirAutocomplete(q).then(function (items) {
                routeStartResults.innerHTML = "";
                (items || []).forEach(function (item) {
                  var title = (item.title || item.address || item.name || item.text || "").trim();
                  var y = item.y != null ? parseFloat(item.y) : (item.lat != null ? parseFloat(item.lat) : null);
                  var x = item.x != null ? parseFloat(item.x) : (item.lon != null ? parseFloat(item.lon) : null);
                  if (y == null || x == null) { var geom = item.geom || item.geometry; if (geom && geom.coordinates && geom.coordinates.length >= 2) { x = geom.coordinates[0]; y = geom.coordinates[1]; } }
                  if (y == null || x == null) return;
                  var div = document.createElement("div");
                  div.className = "team13-search-result-item";
                  div.textContent = title;
                  div.dataset.lat = y;
                  div.dataset.lng = x;
                  div.addEventListener("click", function () {
                    var setStart = window.Team13MapData.setStartFromCoords;
                    var setDest = window.Team13MapData.setDestFromCoords;
                    var draw = window.Team13MapData.drawRouteFromToIfBoth;
                    var dest = window._team13RouteDestFavorite;
                    if (setStart) setStart(parseFloat(div.dataset.lat), parseFloat(div.dataset.lng), title);
                    if (dest && setDest) setDest(dest.lat, dest.lng, dest.name || "");
                    if (draw) draw();
                    routeStartResults.hidden = true;
                    routeStartResults.innerHTML = "";
                    hideModal(modalRouteStart);
                    if (window.Team13CloseSidebar) window.Team13CloseSidebar();
                    var tabRoutes = document.querySelector("[data-tab=\"routes\"]");
                    if (tabRoutes) tabRoutes.click();
                  });
                  routeStartResults.appendChild(div);
                });
                routeStartResults.hidden = !items || items.length === 0;
              });
            }, 300);
          });
          routeStartSearch.addEventListener("blur", function () { setTimeout(function () { routeStartResults.hidden = true; }, 200); });
        }

        document.querySelectorAll(".team13-btn-modal-close[data-close]").forEach(function (btn) {
          btn.addEventListener("click", function () {
            var id = btn.getAttribute("data-close");
            var el = document.getElementById(id);
            hideModal(el);
            if (id === "team13-modal-add-favorite" && modalList) showModal(modalList);
          });
        });

        document.querySelectorAll(".team13-modal-overlay").forEach(function (overlay) {
          overlay.addEventListener("click", function (e) {
            if (e.target === overlay) {
              overlay.hidden = true;
              overlay.classList.remove("team13-modal-open");
              if (overlay.id === "team13-modal-add-favorite" && window.Team13MapData && typeof window.Team13MapData.clearFavoritePickMarker === "function")
                window.Team13MapData.clearFavoritePickMarker();
              if (["team13-modal-add-favorite","team13-modal-favorites-list","team13-modal-route-start","team13-modal-favorite-details"].indexOf(overlay.id) !== -1)
                document.body.classList.remove("team13-favorite-modal-open");
            }
          });
        });
      })();
    </script>
  </body>
</html>
